# リポジトリを clone する
- name: git clone to <subdomain>.xxx.xxx/worktree directory
  command: >-
    /usr/local/bin/git clone {{ www_dir }}/{{ subdomain }}.{{ domain }}/{{ repo_dir }} {{ worktree_dir }}
    chdir={{ www_dir }}/{{ subdomain }}.{{ domain }}
  sudo: no

# git push した時に、worktree の内容を push したブランチに切り替える Git Hook を設定する。
- name: set post-update git hook
  template: >-
    src=./templates/git_post_update.j2
    dest={{ www_dir }}/{{ subdomain }}.{{ domain }}/{{ repo_dir }}/hooks/post-update
    owner={{ user }}
    group={{ group }}
    mode=0755
    follow=yes
  sudo: no

# htdocs に worktree/htdocs へのシンボリックリンクを設定する
# 事前に htdocs ディレクトリを作成しているので強制的にシンボリックリンクで上書き
- name: set symlink htdocs to worktree/htdocs
  file: >-
    src={{ www_dir }}/{{ subdomain }}.{{ domain }}/{{ worktree_dir }}/{{ docroot }}
    dest={{ www_dir }}/{{ subdomain }}.{{ domain }}/{{ docroot }}
    state=link
    force=yes
  sudo: no
